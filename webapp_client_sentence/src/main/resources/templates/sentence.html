<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
	<!-- Bootstrap CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" th:href="@{/css/bootstrap.min.css}" />
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js" th:src="@{/js/jquery-1.11.0.min.js}" ></script>
	<meta charset="UTF-8"/>	
</head>
<body>

	<div class="container">
    	<div class="starter-template">
        	<h1>Oraci칩n generada din치micamente</h1>
        	<button class="lead" id="btnSentence">Obtener Oraci칩n</button>
        	
        	<p class="lead"><span id="sentence"></span> 
        	</p> 
      	</div>
      	
    	<div id="error" class="text-danger">
      	</div>

    </div>
<script th:inline="javascript">
	/*<![CDATA[*/
	    var authorizationCode = /*[[${authorizationCode}]]*/ 'default';
	    console.log(authorizationCode);
	/*]]>*/
</script>
<script type="text/javascript">
	var access_token = "";
	function displaySentence(results) {
		$("#sentence").html(results.text);
	}
	
	//	Handle Errors:	
	function displayErrorSentence(xhr, status, msg) {
		var text = xhr.responseText;
		var emsg = "<p><b>AJAX Fall칩 obteniendo oracion: " + xhr.statusText + " " + msg + "</b><br/></p>";
		$("#error").append(emsg);
		$("#error").show();
	}
	
	$("#btnSentence").click(function(){
		debugger;
		const apiSenteceURL = "http://127.0.0.1:8090/apisentence";
		$.ajax({
		  type: "GET",
		  url: apiSenteceURL + "/get",
		  success: displaySentence,
		  crossDomain: true,
   		  //dataType: 'jsonp',
		  failure: displayErrorSentence,
		  dataType: "json",
		   headers: {
				    "Authorization": 'Bearer ' + access_token
				  }
		});	
	});
	
	$(document).ready(function() {
		debugger;
	   const authorizeUrl = "http://auth-server:9000/oauth2/authorize";
	   const tokenUrl = "http://auth-server:9000/oauth2/token";
	   const redirectUrl = "http://auth-client:9050/authorizationCodeFromSysSentence"; 
	   const clientId = "sentencewebmobile";
	   const scope = "openid";
	   const responseType = "code";
	   if(authorizationCode){
		   var authParams = { 
		   grant_type: "authorization_code", 
			code: authorizationCode, 
			client_id: clientId, 
			client_secret: "4321",  
			redirect_uri: redirectUrl 
		   };
		   $.ajax({
			  type: "POST",
			  url: tokenUrl,
			  data: authParams,
			  success: function(data){
				debugger;
				 access_token = data.access_token; 
				 $.ajaxSetup({
				  type: "POST",
				   headers: {
				    "Authorization": 'Bearer ' + access_token
				  }
				 });
				 $.ajax({
				  headers: {
				    "Authorization": 'Bearer ' + access_token
				  }
				});
			  },
			  dataType: "json"
			});
	   }else{
		   var params = { client_id: clientId, scope: scope, redirect_uri: redirectUrl,  response_type: responseType,  response_mode: "query" };
		   var paramsAsUrl = jQuery.param( params );
		   var authorizeUrlFinal = authorizeUrl + "?" + paramsAsUrl;
		   document.location = authorizeUrlFinal; 
	   } 
	   
	   console.log("URL: " + authorizeUrlFinal);
	   
	});
</script>

</body>
</html>